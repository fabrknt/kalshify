// Fabrknt Suite Database Schema
// Supports PULSE, TRACE, and FABRIC

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==========================================
// SHARED MODELS (Used across all apps)
// ==========================================

model User {
  id            String   @id @default(uuid())
  walletAddress String   @unique
  email         String?  @unique
  username      String   @unique
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // PULSE relations
  contributions Contribution[]
  praisesGiven  Praise[]       @relation("PraiseFrom")
  praisesReceived Praise[]     @relation("PraiseTo")
  sbtTokens     SBTToken[]
  organizations OrganizationMember[]

  // TRACE relations
  campaigns     Campaign[]

  // FABRIC relations
  listings      Listing[]
  ndaSignatures NDASignature[]
  proofOfFunds  ProofOfFunds[]
  escrowsAsBuyer  Escrow[]     @relation("EscrowBuyer")
  escrowsAsSeller Escrow[]     @relation("EscrowSeller")

  @@index([walletAddress])
  @@index([email])
}

// ==========================================
// PULSE MODELS (Team Vitality)
// ==========================================

model Organization {
  id          String   @id @default(uuid())
  name        String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  members      OrganizationMember[]
  healthScores HealthScore[]
  listings     Listing[]

  @@index([name])
}

model OrganizationMember {
  id             String   @id @default(uuid())
  userId         String
  organizationId String
  role           String   @default("member") // admin, member
  joinedAt       DateTime @default(now())

  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([userId, organizationId])
  @@index([userId])
  @@index([organizationId])
}

model Contribution {
  id           String   @id @default(uuid())
  userId       String
  platform     String   // github, discord, notion
  activityType String   // pr, commit, review, message, voice, doc_edit
  qualityScore Float    // 0-100
  quantity     Int      @default(1)
  timestamp    DateTime @default(now())
  metadata     Json?    // platform-specific data

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([platform])
  @@index([timestamp])
}

model Praise {
  id        String   @id @default(uuid())
  fromUserId String
  toUserId   String
  message    String
  contextChannelId String? // Discord channel ID
  timestamp DateTime @default(now())

  fromUser User @relation("PraiseFrom", fields: [fromUserId], references: [id], onDelete: Cascade)
  toUser   User @relation("PraiseTo", fields: [toUserId], references: [id], onDelete: Cascade)

  @@index([fromUserId])
  @@index([toUserId])
  @@index([timestamp])
}

model SBTToken {
  id              String   @id @default(uuid())
  userId          String
  chain           String   // base, polygon, solana
  contractAddress String
  tokenId         String?
  milestoneLevel  String   // bronze, silver, gold, platinum
  issuedAt        DateTime @default(now())
  txHash          String   @unique

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([chain])
  @@index([txHash])
}

model HealthScore {
  id             String   @id @default(uuid())
  organizationId String
  score          Float    // 0-100
  period         String   // weekly, monthly
  startDate      DateTime
  endDate        DateTime
  metrics        Json     // detailed breakdown
  createdAt      DateTime @default(now())

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([startDate])
}

// ==========================================
// TRACE MODELS (Marketing Attribution & Activity)
// ==========================================

model Campaign {
  id                    String   @id @default(uuid())
  ownerId               String
  name                  String
  targetContractAddress String
  chainType             String   // solana, evm
  budgetUsd             Float?
  goalType              String   // conversions, volume, users
  goalValue             Float?
  status                String   @default("active") // active, paused, completed
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  owner       User         @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  clicks      Click[]
  conversions Conversion[]

  @@index([ownerId])
  @@index([targetContractAddress])
  @@index([status])
}

model Click {
  id         String   @id @default(uuid())
  campaignId String
  ipHash     String   // hashed for privacy
  referrer   String?
  userAgent  String?
  utmParams  Json?    // utm_source, utm_medium, utm_campaign, etc.
  timestamp  DateTime @default(now())

  campaign    Campaign     @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  conversions Conversion[]

  @@index([campaignId])
  @@index([timestamp])
  @@index([ipHash])
}

model Conversion {
  id            String   @id @default(uuid())
  clickId       String?  // nullable for organic conversions
  campaignId    String
  walletAddress String
  txHash        String   @unique
  eventType     String   // mint, swap, stake, vote, etc.
  valueUsd      Float?
  timestamp     DateTime @default(now())

  click    Click?   @relation(fields: [clickId], references: [id], onDelete: SetNull)
  campaign Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  @@index([clickId])
  @@index([campaignId])
  @@index([walletAddress])
  @@index([timestamp])
  @@index([txHash])
}

model ActivityMetrics {
  id                String   @id @default(uuid())
  contractAddress   String
  chain             String   // solana, evm
  date              DateTime // daily aggregation
  dau               Int      // daily active users
  wau               Int?     // weekly active users
  mau               Int?     // monthly active users
  txCount           Int      // transaction count
  volumeUsd         Float?   // transaction volume in USD
  activityScore     Float    // 0-100 composite score
  createdAt         DateTime @default(now())

  @@unique([contractAddress, chain, date])
  @@index([contractAddress])
  @@index([date])
}

model ContractInteraction {
  id              String   @id @default(uuid())
  walletAddress   String
  contractAddress String
  functionName    String?
  timestamp       DateTime
  txHash          String   @unique
  valueUsd        Float?
  chain           String   // solana, evm

  @@index([walletAddress])
  @@index([contractAddress])
  @@index([timestamp])
  @@index([txHash])
}

// ==========================================
// FABRIC MODELS (M&A Terminal)
// ==========================================

model Listing {
  id                String   @id @default(uuid())
  sellerWallet      String
  organizationId    String?  // link to PULSE organization
  projectName       String
  category          String   // defi, nft, dao, gaming, infrastructure
  askingPriceUsd    Float
  status            String   @default("draft") // draft, active, under_nda, sold
  description       String
  revenueUsd        Float?
  monthlyActiveUsers Int?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  seller          User             @relation(fields: [sellerWallet], references: [walletAddress], onDelete: Cascade)
  organization    Organization?    @relation(fields: [organizationId], references: [id], onDelete: SetNull)
  ndaSignatures   NDASignature[]
  escrows         Escrow[]
  suiteRibbonData SuiteRibbonData?

  @@index([sellerWallet])
  @@index([organizationId])
  @@index([status])
  @@index([category])
}

model SuiteRibbonData {
  id                 String   @id @default(uuid())
  listingId          String   @unique
  pulseVitalityScore Float?   // 0-100 from PULSE
  traceDau           Int?     // from TRACE
  traceWau           Int?
  traceMau           Int?
  traceActivityScore Float?   // 0-100 from TRACE
  fabricScore        Float?   // composite score
  lastUpdated        DateTime @updatedAt

  listing Listing @relation(fields: [listingId], references: [id], onDelete: Cascade)

  @@index([listingId])
}

model NDASignature {
  id              String   @id @default(uuid())
  listingId       String
  buyerWallet     String
  signatureHash   String   // EIP-191/EIP-712 signature
  signedAt        DateTime @default(now())
  accessExpiresAt DateTime // typically 7 days from signedAt

  listing Listing @relation(fields: [listingId], references: [id], onDelete: Cascade)
  buyer   User    @relation(fields: [buyerWallet], references: [walletAddress], onDelete: Cascade)

  @@unique([listingId, buyerWallet])
  @@index([listingId])
  @@index([buyerWallet])
}

model ProofOfFunds {
  id                 String   @id @default(uuid())
  buyerWallet        String
  verifiedBalanceUsd Float
  verificationTxHash String?
  verifiedAt         DateTime @default(now())
  expiresAt          DateTime // 24 hours validity

  buyer User @relation(fields: [buyerWallet], references: [walletAddress], onDelete: Cascade)

  @@index([buyerWallet])
  @@index([verifiedAt])
}

model Escrow {
  id                  String   @id @default(uuid())
  listingId           String
  buyerWallet         String
  sellerWallet        String
  escrowContractAddress String @unique
  status              String   @default("initialized") // initialized, deposited, completed, refunded
  assets              Json     // description of assets being transferred
  createdAt           DateTime @default(now())
  completedAt         DateTime?

  listing Listing @relation(fields: [listingId], references: [id], onDelete: Cascade)
  buyer   User    @relation("EscrowBuyer", fields: [buyerWallet], references: [walletAddress], onDelete: Cascade)
  seller  User    @relation("EscrowSeller", fields: [sellerWallet], references: [walletAddress], onDelete: Cascade)

  @@index([listingId])
  @@index([buyerWallet])
  @@index([sellerWallet])
  @@index([status])
}
